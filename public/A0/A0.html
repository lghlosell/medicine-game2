<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>真武汤·附子奇缘</title>
    <link rel="stylesheet" href="A0.css"></link>

</head>
<body>
    <div class="intro-screen" onclick="handleIntroClick()">
        <div class="intro-text">
            <p>药王谷灵气氤氲，百草丰茂，自古便是中药材生长的绝佳之地。</p>
            <p>谷中住着一位杏林圣手——孙老，我名韩立，幸得拜入门下，随师修习岐黄之术。</p>
            <p>这日洒扫毕，忽见案头横陈一册《伤寒论》，纸色微黄，墨香犹存，想是师父遗落。</p>
            <p>指尖距书脊不过半寸，我却如临深渊：擅翻恐犯门规，不翻又心痒如蚁。</p>
            <p>窗外药圃风起，叶影摇曳，似在替我斟酌。</p>
        </div>
        <!-- Click anywhere to continue -->
        <div class="click-hint">点击任意处继续</div>
    </div>

    <div id="book-interaction" style="position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10; cursor: pointer;" onclick="switchBackground()"></div>

    <!-- Full screen click area for reading scene -->
    <div id="read-scene-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 99; cursor: pointer;" onclick="showNextScene()"></div>

    <div class="ancient-book-text" id="ancient-book-text" style="display: none; pointer-events: none;">
        <p>“太阳病，发汗，汗出不解，其人仍发热，心下悸，头眩，身瞤动，振振欲擗地者，<span class="highlight-red">真武汤</span>主之。”</p>
    </div>

    <!-- Removed continue-btn -->

    <div class="transition-screen" id="transition-screen" style="display: none;">
        <div class="transition-text">
            <p>正当我看得入神，耳边忽飘来一句带笑的调侃：</p>
            <p>“哟，这么勤奋，扫地还偷看书？”</p>
            <p>我猛地抬头——师父抱臂倚门，夕阳给他镀了层暖金，眼底映着摇曳药影，像两潭含风的深水。</p>
        </div>
    </div>

    <div class="dialog-container" id="dialog-container" style="display: none;">
        <!-- Removed apprentice-bubble per user request -->
        <!-- <div class="dialog-bubble apprentice-bubble">
            <p>师父，徒儿已经打扫完了，桌上有本书，在学习书中的真武汤。</p>
        </div> -->
        <div class="dialog-bubble master-bubble" style="display: none;">
            <p>“徒儿，欲习真武汤之精妙，必先通晓其君药附子。”</p>
            <p>“附子如猛虎，用当则回阳救逆，起死回生；用失则祸患无穷，伤及性命。今日，你需闯过七重考验，洞悉附子之性、用、毒、解、配，方能领悟真武汤真谛。准备好了吗？”</p>
        </div>

        <div class="ready-btn-container"><button class="ready-btn" id="ready-btn" style="display: none;" onclick="window.location.href='../A1/A1.html'">准备好了</button></div>
    </div>



    <!-- Book Icon Trigger -->
    <div class="book-icon" id="book-icon" onclick="showBookPopup()" style="display: none;">
        📖
    </div>

    <!-- Centered Book Popup -->
    <div class="book-popup-overlay" id="book-popup-overlay" onclick="closeBookPopup()" style="display: none;">
        <div class="ancient-book-popup" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeBookPopup()">×</div>
            <div class="book-content">
                <p>“太阳病，发汗，汗出不解，其人仍发热，心下悸，头眩，身瞤动，振振欲擗地者，<span class="highlight-red">真武汤</span>主之。”</p>
                <p>“少阴病，二三日不已，至四五日，腹痛，小便不利，四肢沉重疼痛，自下利者，此为有水气。其人或咳，或小便利，或下利，或呕者，<span class="highlight-red">真武汤</span>主之。”</p>
            </div>
        </div>
    </div>

    <script>
        // Voice Selection Logic
        let selectedVoice = null;

        function initVoices() {
            return new Promise((resolve) => {
                let voices = window.speechSynthesis.getVoices();
                if (voices.length !== 0) {
                    resolve(voices);
                } else {
                    window.speechSynthesis.onvoiceschanged = () => {
                        voices = window.speechSynthesis.getVoices();
                        resolve(voices);
                    };
                }
            });
        }

        async function getPreferredVoice() {
            if (selectedVoice) return selectedVoice;

            const voices = await initVoices();
            // Try to find a Chinese voice
            const zhVoices = voices.filter(voice => voice.lang.includes('zh') || voice.lang.includes('CN'));
            
            if (zhVoices.length > 0) {
                // Try to find a voice that sounds more like a young man/boy (Youthful).
                // Often, higher pitch male voices or neutral female voices with adjusted pitch work well.
                // Windows: "Kangkang" is adult male. "Huihui" or "Yaoyao" are female but can simulate youth with pitch.
                // "Yunyang" (if available) is a male news reading voice, might be too formal.
                // Let's try to find a male voice first, but we will adjust pitch higher.
                const maleVoice = zhVoices.find(v => v.name.includes('Male') || v.name.includes('Kangkang') || v.name.includes('Danny'));
                
                selectedVoice = maleVoice || zhVoices.find(v => v.name.includes('Google')) || zhVoices[0];
            }
            
            return selectedVoice;
        }

        // Intro Speech Logic
        let currentAudio = null;
        let audioStarted = false;

        async function playIntroSpeech() {
            // Play the pre-recorded audio (voice1.mp3) which corresponds to intro-text
            const audioPath = '../../assets/voice/voice1.mp3';
            
            // Stop any existing audio/speech
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }

            // Create and play audio
            currentAudio = new Audio(audioPath);
            
            // Fallback to TTS if audio fails
            currentAudio.onerror = async () => {
                console.log("Audio file voice1.mp3 not found or error, falling back to TTS");
                const introText = "药王谷灵气氤氲，百草丰茂，自古便是中药材生长的绝佳之地。谷中住着一位杏林圣手——孙老，我名韩立，幸得拜入门下，随师修习岐黄之术。这日洒扫毕，忽见案头横陈一册《伤寒论》，纸色微黄，墨香犹存，想是师父遗落。指尖距书脊不过半寸，我却如临深渊：擅翻恐犯门规，不翻又心痒如蚁。窗外药圃风起，叶影摇曳，似在替我斟酌。";
                
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(introText);
                    const voice = await getPreferredVoice();
                    if (voice) utterance.voice = voice;
                    
                    utterance.lang = 'zh-CN';
                    utterance.rate = 1.1; 
                    utterance.pitch = 1.3;
                    window.speechSynthesis.speak(utterance);
                    
                    // Assume TTS starts successfully
                    audioStarted = true;
                    document.querySelector('.click-hint').textContent = "点击任意处继续";
                }
            };

            try {
                await currentAudio.play();
                audioStarted = true;
                document.querySelector('.click-hint').textContent = "点击任意处继续";
            } catch (e) {
                if (e.name === 'NotAllowedError') {
                    // Autoplay blocked - expected behavior in some browsers
                    // Don't log error to avoid confusing the user
                    audioStarted = false;
                    document.querySelector('.click-hint').textContent = "点击屏幕开启声音";
                } else {
                    console.error("Audio play failed:", e);
                    // Other errors (e.g. format not supported), trigger onerror
                    // Trigger onerror manually if play fails immediately
                    currentAudio.onerror();
                }
            }
        }

        function handleIntroClick() {
            if (!audioStarted) {
                playIntroSpeech();
            } else {
                hideIntroScreen();
            }
        }

        function hideIntroScreen() {
            const introScreen = document.querySelector('.intro-screen');
            if (introScreen.style.display !== 'none') {
                introScreen.style.display = 'none';
                
                // Stop Audio if playing
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                // Stop TTS if playing
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }

                // Directly switch to read scene
                switchBackground();
            }
        }

        // Try to play speech on load
        window.onload = function() {
            playIntroSpeech();
        };

        function switchBackground() {
            document.body.style.backgroundImage = "url('../../assets/img/read.png')";
            document.getElementById('book-interaction').style.display = 'none';
            document.getElementById('ancient-book-text').style.display = 'block';
            document.getElementById('read-scene-overlay').style.display = 'block';
        }

        function showNextScene() {
            // Hide current elements
            document.getElementById('ancient-book-text').style.display = 'none';
            document.getElementById('read-scene-overlay').style.display = 'none';
            
            // Directly switch to meet scene
            document.body.style.backgroundImage = "url('../../assets/img/meet.png')";

            // Show Ready Button 3 seconds after meet scene loads
            setTimeout(() => {
                document.getElementById('ready-btn').style.display = 'block';
            }, 3000);
            
            // Show dialogs immediately upon entering meet scene
            document.getElementById('dialog-container').style.display = 'flex';
            document.querySelector('.master-bubble').style.display = 'block';

            // Stop previous audio/TTS
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }

            // Play voice2.mp3 (Narrator) first
            const voice2Path = '../../assets/voice/voice2.mp3';
            currentAudio = new Audio(voice2Path);
            
            // Show Book Icon
            document.getElementById('book-icon').style.display = 'flex';

            // When voice2 ends, play voice3 and show dialogs
            currentAudio.onended = () => {
                 playVoice3AndShowDialogs();
            };
            
            // Handle error (skip voice2 if fails)
            currentAudio.onerror = () => {
                console.log("voice2 failed, skipping to voice3");
                playVoice3AndShowDialogs();
            };

            currentAudio.play().catch(e => {
                console.error("Error playing voice2:", e);
                // If play fails (e.g. interaction policy), try to continue anyway or wait for user interaction? 
                // Since user just clicked, it should play. If not, we proceed.
                playVoice3AndShowDialogs();
            });
        }

        function playVoice3AndShowDialogs() {
             // Play voice3.mp3
             const voice3Path = '../../assets/voice/voice3.mp3';
             currentAudio = new Audio(voice3Path);
             currentAudio.play().catch(e => console.error("Error playing voice3:", e));
             
             // Dialogs are already shown in showNextScene
             
             // Sequence: Apprentice speaks (audio only) -> wait -> Master speaks
             // We keep the delay for the button to match the audio timing.
             
             setTimeout(() => {
                 // Master replies after 3 seconds (approximate duration of apprentice's part in voice3)
                 // Show Ready Button after master speaks
                 setTimeout(() => {
                    document.getElementById('ready-btn').style.display = 'block';
                 }, 2000);
             }, 3000); 
        }

        function showBookPopup() {
            document.getElementById('book-popup-overlay').style.display = 'flex';
        }

        function closeBookPopup() {
            document.getElementById('book-popup-overlay').style.display = 'none';
        }
    </script>
    <a class="back-btn" href="../Start/index.html">返回首页</a>
</body>
</html>