<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>真武汤·附子奇缘</title>
    <link rel="stylesheet" href="A3.css"></link>
</head>
<body>
    <!-- Level Name -->
    <div class="level-name">关卡三.剂量之衡</div>
    <!-- Location Name -->
    <div class="location-name">药秤台</div>

    <!-- Master's Question -->
    <div class="question-dialog" id="question-dialog">
        <div class="dialog-content">
            <p>“附子之力，贵在剂量得宜。过则生毒，不及则无功。真武汤中，附子常用几何（真武汤临床常用的附子剂量多大）？”</p>
        </div>
    </div>

    <!-- Scale Instruction -->
    <div class="scale-instruction">
        <div class="arrow-down"></div>
        <div class="instruction-text">请调整杆秤的刻度，回答师父的问题</div>
    </div>
    
    <!-- Scale Click Area -->
    <div class="scale-click-area" onclick="showScalePopup()"></div>

    <!-- Scale Popup -->
    <div class="popup-overlay" id="scale-popup" style="display: none;" onclick="hideScalePopup()">
        <div class="popup-content scale-content" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="hideScalePopup()">×</div>
            <h2>请拖动滑块选择附子剂量</h2>
            <div class="slider-container">
                <div class="ruler-marks">
                    <!-- Marks generated by JS or static HTML -->
                    <!-- 0 to 20 marks -->
                    <div class="mark" style="left: 0%;"></div><div class="mark" style="left: 5%;"></div><div class="mark" style="left: 10%;"></div><div class="mark" style="left: 15%;"></div><div class="mark" style="left: 20%;"></div>
                    <div class="mark" style="left: 25%;"></div><div class="mark" style="left: 30%;"></div><div class="mark" style="left: 35%;"></div><div class="mark" style="left: 40%;"></div><div class="mark" style="left: 45%;"></div>
                    <div class="mark" style="left: 50%;"></div><div class="mark" style="left: 55%;"></div><div class="mark" style="left: 60%;"></div><div class="mark" style="left: 65%;"></div><div class="mark" style="left: 70%;"></div>
                    <div class="mark" style="left: 75%;"></div><div class="mark" style="left: 80%;"></div><div class="mark" style="left: 85%;"></div><div class="mark" style="left: 90%;"></div><div class="mark" style="left: 95%;"></div><div class="mark" style="left: 100%;"></div>
                </div>
                <div class="ruler-numbers">
                    <span style="left: 0%;">0</span>
                    <span style="left: 25%;">5</span>
                    <span style="left: 50%;">10</span>
                    <span style="left: 75%;">15</span>
                    <span style="left: 100%;">20</span>
                    <span style="left: 108%; font-size: 0.8em;">(g)</span>
                </div>
                <input type="range" min="0" max="20" value="0" class="slider" id="doseSlider" oninput="updateDoseValue(this.value)">
                <div class="dose-display"><span id="doseValue">0</span> g</div>
            </div>
            
            <!-- Weights and Tray Section -->
            <div class="weights-section">
                <div class="weights-source">
                    <div class="weight-label">铁疙瘩</div>
                    <div class="weight-items">
                        <div class="weight w-5" draggable="true" ondragstart="drag(event)" data-weight="5">5g</div>
                        <div class="weight w-10" draggable="true" ondragstart="drag(event)" data-weight="10">10g</div>
                        <div class="weight w-20" draggable="true" ondragstart="drag(event)" data-weight="20">20g</div>
                    </div>
                </div>
                <div class="weights-tray" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="tray-label">托盘 (点击移除)</div>
                    <div id="tray-container"></div>
                </div>
            </div>

            <button class="confirm-btn" onclick="checkDose()">确 定</button>
        </div>
    </div>

    <!-- Right Toolbar -->
    <div class="game-toolbar">
        <div class="tool-item" onclick="showBook()" title="查看经文">
            📖
        </div>
        <div class="tool-item" onclick="showHint()" title="查看提示">
            🔍
        </div>
    </div>

    <!-- Next Level Button -->
    <button class="next-level-btn" id="next-level-btn" onclick="goToNextLevel()">下一关</button>

    <!-- Book Popup -->
    <div class="popup-overlay" id="book-popup" style="display: none;" onclick="hideBook()">
        <div class="popup-content book-style" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="hideBook()">×</div>
            <div class="book-pages">
                <!-- Page 1: Scripture -->
                <div class="book-page" id="book-page-1">
                    <div class="book-text">
                        <p>“太阳病，发汗，汗出不解，其人仍发热，心下悸，头眩，身瞤动，振振欲擗地者，<span class="highlight-red">真武汤</span>主之。”</p>
                        <p>“少阴病，二三日不已，至四五日，腹痛，小便不利，四肢沉重疼痛，自下利者，此为有水气。其人或咳，或小便利，或下利，或呕者，<span class="highlight-red">真武汤</span>主之。”</p>
                    </div>
                </div>
                <!-- Page 2: A1 Content -->
                <div class="book-page" id="book-page-2" style="display: none;">
                    <div class="book-text">
                        <p>生附子，呈乌黑之色，带着粗糙的外皮，形状不规则，凑近能闻到一股轻微的辛辣腥气；熟附子，是黄白色的切片，质地温润，表面光滑，散发着淡淡的药香。</p>
                        <p>生附子毒性猛烈，多用于回阳救逆之急救，不合适真武汤。熟附子经炮制，毒性大减，药性温煦持久，正合真武汤温阳利水之需。</p>
                    </div>
                </div>
                <!-- Page 3: A2 Content -->
                <div class="book-page" id="book-page-3" style="display: none;">
                    <div class="book-text">
                        <p>生附子回阳救逆，熟附子温补命门，二者各有所长</p>
                    </div>
                </div>
                <!-- Page 4: A3 Content -->
                <div class="book-page" id="book-page-4" style="display: none;">
                    <div class="book-text">
                        <p>附子3g以下恐难奏效，15g以上风险陡增，非经验丰富者不可轻用。约合今之3至15克。</p>
                        <p>炮制得法，剂量适中，方能回阳救逆而不伤正。然需谨记，具体用量须遵医嘱，因人、因证而异。</p>
                    </div>
                </div>
            </div>
            <!-- Pagination Controls -->
            <div class="book-pagination" id="book-pagination" style="display: flex;">
                <button class="page-btn" id="prev-btn" onclick="changePage(-1)" disabled>上一页</button>
                <span class="page-indicator" id="page-indicator">1 / 4</span>
                <button class="page-btn" id="next-btn" onclick="changePage(1)">下一页</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 4;

        function showBook() {
            document.getElementById('book-popup').style.display = 'flex';
        }

        function hideBook() {
            document.getElementById('book-popup').style.display = 'none';
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updatePagination();
            }
        }

        function updatePagination() {
            document.querySelectorAll('.book-page').forEach(page => page.style.display = 'none');
            document.getElementById(`book-page-${currentPage}`).style.display = 'block';
            document.getElementById('page-indicator').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
        }

        function showHint() {
            alert("提示：回顾师父的教诲。");
        }

        function showScalePopup() {
            document.getElementById('scale-popup').style.display = 'flex';
            // Hide instruction when clicked
            document.querySelector('.scale-instruction').style.display = 'none';
            // Initialize dose display position and calculation
            const slider = document.getElementById('doseSlider');
            updateDoseValue(slider.value);
        }

        function hideScalePopup() {
            document.getElementById('scale-popup').style.display = 'none';
        }
        
        // Drag and Drop Logic
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("weight", ev.target.dataset.weight);
            ev.dataTransfer.setData("type", "new");
        }

        function drop(ev) {
            ev.preventDefault();
            const weightVal = parseInt(ev.dataTransfer.getData("weight"));
            if (isNaN(weightVal)) return;

            // Check if weight already used (although disabled state prevents drag, good to double check)
            if (isWeightUsed(weightVal)) return;

            addWeightToTray(weightVal);
        }

        let trayWeights = [];

        function isWeightUsed(val) {
            return trayWeights.includes(val);
        }

        function setWeightDisabled(val, disabled) {
            const el = document.querySelector(`.weights-source .w-${val}`);
            if (el) {
                if (disabled) {
                    el.classList.add('disabled');
                    el.draggable = false;
                } else {
                    el.classList.remove('disabled');
                    el.draggable = true;
                }
            }
        }

        function addWeightToTray(val) {
            trayWeights.push(val);
            setWeightDisabled(val, true);
            renderTray();
            updateTotalCalculation();
        }

        function removeWeightFromTray(index) {
            const removedVal = trayWeights[index];
            trayWeights.splice(index, 1);
            setWeightDisabled(removedVal, false);
            renderTray();
            updateTotalCalculation();
        }

        function renderTray() {
            const container = document.getElementById('tray-container');
            container.innerHTML = '';
            trayWeights.forEach((w, index) => {
                const el = document.createElement('div');
                el.className = `weight w-${w} tray-item`;
                el.textContent = w + 'g';
                el.onclick = () => removeWeightFromTray(index);
                el.title = "点击移除";
                container.appendChild(el);
            });
        }

        function updateDoseValue(val) {
            // Just update UI for slider, but actual calc is combined
            updateTotalCalculation();
        }

        function updateTotalCalculation() {
            const sliderVal = parseInt(document.getElementById('doseSlider').value);
            const trayTotal = trayWeights.reduce((a, b) => a + b, 0);
            const total = sliderVal + trayTotal;

            // Update Text
            const displayEl = document.getElementById('doseValue');
            if(displayEl) {
                displayEl.textContent = total;
            }

            // Update Bubble Position based on SLIDER value
            const slider = document.getElementById('doseSlider');
            const min = slider.min ? parseInt(slider.min) : 0;
            const max = slider.max ? parseInt(slider.max) : 100;
            const newVal = Number(((sliderVal - min) * 100) / (max - min));
            
            const bubble = document.querySelector('.dose-display');
            if(bubble) {
                bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
                
                // Optional: Change bubble color if tray has items to indicate combined weight?
                if (trayTotal > 0) {
                     bubble.style.backgroundColor = "#4e342e"; // Slightly different color
                     bubble.title = `滑块(${sliderVal}g) + 托盘(${trayTotal}g)`;
                } else {
                     bubble.style.backgroundColor = "#2c1810";
                     bubble.title = "";
                }
            }
        }

        function checkDose() {
            const sliderVal = parseInt(document.getElementById('doseSlider').value);
            const trayTotal = trayWeights.reduce((a, b) => a + b, 0);
            const totalDose = sliderVal + trayTotal;
            
            const dialogContent = document.querySelector('#question-dialog .dialog-content p');
            const instructionEl = document.querySelector('.scale-instruction');
            const instructionText = document.querySelector('.instruction-text');
            
            // New range 3-15g
            if (totalDose >= 3 && totalDose <= 15) {
                // Correct range
                dialogContent.textContent = "“善！此乃安全有效之范围，约合今之3至15克。炮制得法，剂量适中，方能回阳救逆而不伤正。然需谨记，具体用量须遵医嘱，因人、因证而异。”";
                hideScalePopup();
                // Show next level button
                document.getElementById('next-level-btn').style.display = 'block';
            } else {
                dialogContent.textContent = `“剂量关乎生死！当前共${totalDose}克（滑块${sliderVal}克 + 托盘${trayTotal}克）。3g以下恐难奏效，15g以上风险陡增，非经验丰富者不可轻用。常规应在3-15g之间谨慎调整。”`;
                hideScalePopup();
                
                // Show instruction again with error message
                if(instructionEl && instructionText) {
                    instructionEl.style.display = 'flex';
                    instructionText.textContent = "剂量不当，请调整";
                }
            }
        }

        function goToNextLevel() {
            window.location.href = '../A4/A4.html';
        }
    </script>
</body>
</html>
